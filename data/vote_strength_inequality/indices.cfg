# Params:
# - vote_data: a "just votes" config, with an "id" column and per-party vote.
#   Note that we don't need the per-party vote, just the total vote counts per
#   district, but standard vote data numbers contain the per-party vote.
# - seat_data: a table that contains columns "id" and "seats".

# Sample usage
# python3 ../../python_lib/cadmium.py "RUN FILE 'indices.cfg' FROM COMMAND 
#            \"RUN FILE '../sejm_election_results/2023_by_community.cfg' >
#                  FILE '../sejm_election_results/just_votes.cfg' >
#                  FILE '../sejm_election_results/by_district.cfg';\",
#            FILE '../district_definitions/2023.cfg' >
#            FILE '../dump.cfg';"

INPUT TABLES votes, seats;
TRANSFORM votes WITH at(1) AS vid, sum_range(2:) AS votes;
AGGREGATE votes TO totvotes WITH sum(votes) AS totvotes;
JOIN totvotes INTO votes ON 1 EQ 1 AS vvtable;
TRANSFORM vvtable WITH vid AS vid, votes / totvotes AS vi;

AGGREGATE seats TO totseats WITH sum(seats) AS totseats;
JOIN totseats INTO seats ON 1 EQ 1 AS sstable;
TRANSFORM sstable WITH id AS sid, seats / totseats AS si;

JOIN sstable INTO vvtable ON sid EQ vid AS indices;
TRANSFORM indices WITH abs(vi - si) AS lh, (vi - si) * (vi - si) AS gh;
AGGREGATE indices WITH sum(lh) / 2 AS lhi, sqrt(sum(gh) / 2) AS ghi;
OUTPUT TABLES indices;
