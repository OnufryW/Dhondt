INPUT TABLES votes;
TRANSFORM votes WITH teryt AS teryt, eligible_voters AS eligible,
                     voters_voting_through_right_to_vote AS right;
RUN FILE "../sejm_election_results/by_district.cfg" FROM votes INTO res;

# Pole "eligible_voters", czyli w oryginalnym pliku "liczba uprawnionych
# do głosowania" oznacza "liczba uprawnionych do głosowania (umieszczonych
# w spisie, z uwzględnieniem dodatkowych formularzy) w chwili zakończenia
# głosowania". Informację tę biorę ze strony PKW, gdzie po wejściu w
# protokół konkretnej komisji pojawia się to obszerniejsze wyjaśnienie,
# sprawdziłem też na przykładzie jednej gminy, że dane się zgadzają.
TRANSFORM res TO pcztery WITH district AS district, eligible - right AS param;
RUN FILE "../distribute_seats/niemeyer.cfg"
    FROM pcztery INTO pcztery;
TRANSFORM pcztery WITH id AS cid, seats AS cseats;

TRANSFORM res TO ppiec WITH district AS district, eligible AS param;
RUN FILE "../distribute_seats/niemeyer.cfg"
    FROM ppiec INTO ppiec;
TRANSFORM ppiec WITH id AS pid, seats AS pseats;

JOIN pcztery INTO ppiec ON cid EQ pid WITH RAISE UNMATCHED KEYS AS final;
TRANSFORM final WITH cid AS id, cseats AS pcztery, pseats AS ppiec;
OUTPUT TABLES final;
